<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Creator - Your Online Store</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #23e5db;
            --accent-color: #ffce32;
            --light-color: #f2f4f5;
            --dark-color: #002f34;
            --success-color: #00a650;
            --warning-color: #ff6b6b;
            --bg-color: #f2f4f5;
            --text-color: #002f34;
            --card-bg: white;
            --input-bg: white;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            padding-bottom: 70px;
            margin: 0;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .loading-circle {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Main Content */
        #main-content {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        /* Shop Not Found */
        #shop-not-found {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .not-found-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .not-found-card i {
            font-size: 80px;
            color: #f43f5e;
            margin-bottom: 20px;
        }

        .not-found-card h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .not-found-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .btn-home {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.3s;
        }

        .btn-home:hover {
            transform: translateY(-2px);
            color: white;
        }

        /* Image Banner */
        .image-banner {
            width: 100%;
            overflow: hidden;
            margin-bottom: 0px;
            position: relative;
        }

        .banner-container {
            position: relative;
            width: 100%;
            height: 200px;
        }

        .banner-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .banner-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
            padding: 15px;
        }

        .banner-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .banner-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 5px 0 0 0;
        }

        .banner-skeleton {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Shop Info */
        .shop-info-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: -30px 20px 20px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .shop-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .shop-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 10px 0 5px 0;
            color: var(--text-color);
        }

        .shop-meta {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .shop-meta span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--light-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-color);
        }

        /* Search Container */
        .search-container {
            margin: 20px;
        }

        .search-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 12px 45px 12px 15px;
            border-radius: 25px;
            border: 1px solid #ddd;
            height: 50px;
            width: 100%;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
            outline: none;
        }

        .clear-search {
            position: absolute;
            right: 50px;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            display: none;
            z-index: 5;
        }

        .search-btn {
            position: absolute;
            right: 0px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: black;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            padding: 0 15px;
            margin-top: 20px;
        }

        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            cursor: pointer;
            color: var(--text-color);
            border: 1px solid rgba(0, 47, 52, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .product-img-container {
            height: 160px;
            overflow: hidden;
            position: relative;
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-card:hover .product-img {
            transform: scale(1.08);
        }

        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 2;
        }

        .product-info {
            padding: 12px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-title {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-color);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            min-height: 2.6rem;
        }

        .product-price-container {
            margin-bottom: 10px;
        }

        .product-price {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .product-old-price {
            text-decoration: line-through;
            opacity: 0.6;
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .btn-buy {
            background-color: black;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 0.85rem;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: auto;
            cursor: pointer;
        }

        .btn-buy:hover {
            background-color: #333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 15px;
            margin: 20px;
        }

        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

        /* Products Loading */
        .products-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
            grid-column: 1 / -1;
        }

        .products-loading-circle {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: black;
            animation: spin 1s linear infinite;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-img {
            height: 160px;
            width: 100%;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-text-sm {
            height: 12px;
            width: 70%;
        }

        /* Product Modal */
        .product-modal .modal-dialog {
            max-width: 900px;
            margin: 1.75rem auto;
        }

        .product-modal .modal-content {
            border-radius: 16px;
            overflow: hidden;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .product-modal .modal-header {
            border-bottom: 1px solid #eee;
            padding: 1rem 1.5rem;
            background: white;
        }

        .product-modal .modal-title {
            font-weight: 600;
            color: black;
            font-size: 1.2rem;
        }

        .product-modal .btn-close {
            background: transparent;
            opacity: 0.7;
        }

        .product-modal .btn-close:hover {
            opacity: 1;
        }

        .product-modal .modal-body {
            padding: 1.5rem;
        }

        .product-gallery-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 12px;
            background: #f8f9fa;
        }

        .product-gallery-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .product-gallery-scroll::-webkit-scrollbar {
            display: none;
        }

        .product-gallery-slide {
            flex: 0 0 auto;
            width: 100%;
            scroll-snap-align: start;
        }

        .product-gallery-image {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background-color: #f8f9fa;
        }

        .image-gallery-dots {
            position: absolute;
            bottom: 15px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }

        .image-gallery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            padding: 0;
        }

        .image-gallery-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .image-gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 11;
            border: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .product-gallery-container:hover .image-gallery-nav {
            opacity: 1;
        }

        .image-gallery-nav.prev {
            left: 15px;
        }

        .image-gallery-nav.next {
            right: 15px;
        }

        .product-info-details {
            padding-left: 1rem;
        }

        .product-modal-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: black;
        }

        .product-price-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .current-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: black;
        }

        .old-price {
            text-decoration: line-through;
            opacity: 0.6;
            font-size: 1.2rem;
            color: #666;
        }

        .discount-badge {
            background-color: var(--success-color);
            color: white;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .product-description {
            margin: 1.5rem 0;
            line-height: 1.6;
            color: #555;
            white-space: pre-line;
        }

        .action-buttons {
            margin-top: 2rem;
        }

        .btn-buy-now {
            background-color: black;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .btn-buy-now:hover {
            background-color: #333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .swipe-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 0;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
        }

        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .bottom-nav-item.active {
            color: black;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            background: white;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
            color: #666;
            border-top: 1px solid #eee;
        }

        .footer a {
            color: black;
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .banner-container {
                height: 150px;
            }

            .banner-title {
                font-size: 1.2rem;
            }

            .banner-subtitle {
                font-size: 0.8rem;
            }

            .product-modal .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }

            .product-modal .modal-body {
                padding: 1rem;
            }

            .product-gallery-image {
                height: 250px;
            }

            .product-modal-name {
                font-size: 1.4rem;
            }

            .current-price {
                font-size: 1.5rem;
            }

            .image-gallery-nav {
                display: none;
            }
        }

        @media (min-width: 768px) {
            .banner-container {
                height: 250px;
            }
        }

        @media (min-width: 992px) {
            .banner-container {
                height: 300px;
            }
            
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="text-center">
            <div class="loading-circle"></div>
        </div>
    </div>

    <!-- Shop Not Found -->
    <div id="shop-not-found" style="display: none;">
        <div class="not-found-card">
            <i class="fas fa-store-slash"></i>
            <h1>Shop Not Found</h1>
            <p>The shop you're looking for doesn't exist or has been removed.</p>
            <a href="https://aliezzedine456.github.io/Marko/" class="btn-home">
                <i class="fas fa-home"></i> Go to Home
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Image Banner -->
        <div class="image-banner" id="imageBanner">
            <div class="banner-container">
                <div class="banner-skeleton" id="bannerSkeleton"></div>
                <div id="bannerContent" style="display: none;">
                    <img src="" class="banner-image" id="shop-banner-img" alt="Shop Banner">
                    <div class="banner-overlay">
                        <h2 class="banner-title" id="shop-banner-title"></h2>
                        <p class="banner-subtitle" id="shop-banner-subtitle"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shop Info Card -->
        <div class="shop-info-card text-center">
            <img class="shop-logo" id="shop-logo" src="" alt="Shop Logo" onerror="this.src='https://via.placeholder.com/150'">
            <h1 class="shop-name" id="shop-name"></h1>
            <div class="shop-meta">
                <span><i class="fas fa-box"></i> <span id="product-count">0</span> Products</span>
                <span><i class="fas fa-calendar"></i> <span id="shop-created"></span></span>
            </div>
        </div>

        <!-- Search Container -->
        <div class="search-container">
            <div class="search-input-group">
                <input type="text" class="search-input" id="searchInput" placeholder="Search products...">
                <button class="clear-search" id="clearSearchBtn">
                    <i class="fas fa-times"></i>
                </button>
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="products-grid" id="products-grid">
            <!-- Skeleton loading -->
            <div class="product-card">
                <div class="skeleton skeleton-img"></div>
                <div class="product-info">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="skeleton skeleton-img"></div>
                <div class="product-info">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="skeleton skeleton-img"></div>
                <div class="product-info">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="skeleton skeleton-img"></div>
                <div class="product-info">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Products Loading Indicator -->
        <div class="products-loading" id="productsLoading" style="display: none;">
            <div class="products-loading-circle"></div>
        </div>

        <!-- No Products Message -->
        <div class="empty-state" id="noProducts" style="display: none;">
            <i class="fas fa-box-open"></i>
            <h3>No Products Found</h3>
            <p>This shop doesn't have any products yet</p>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2024 Shop Creator. All rights reserved. | Powered by <a href="https://aliezzedine456.github.io/Marko/">Shop Creator</a></p>
        </footer>
    </div>

    <!-- Product Modal -->
    <div class="modal fade product-modal" id="product-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-product-title">Product Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="product-gallery-container" id="productGalleryContainer">
                                <div class="product-gallery-scroll" id="productGalleryScroll"></div>
                                <div class="image-gallery-dots" id="imageGalleryDots"></div>
                                <button class="image-gallery-nav prev" id="galleryPrev">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="image-gallery-nav next" id="galleryNext">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 product-info-details">
                            <h3 class="product-modal-name" id="modal-product-name">Product Name</h3>
                            
                            <div class="product-price-container">
                                <span class="current-price" id="modal-product-price">$0.00</span>
                                <span class="old-price" id="modal-product-old-price" style="display: none;"></span>
                                <span class="discount-badge" id="modal-product-discount" style="display: none;"></span>
                            </div>
                            
                            <div class="product-description" id="modal-product-description" style="white-space: pre-line;">
                                Product description goes here
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn-buy-now" id="modal-buy-btn">
                                    <i class="fas fa-external-link-alt me-1"></i> View Product
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="container">
            <div class="row">
                <div class="col-6">
                    <button class="bottom-nav-item active" id="homeNavBtn">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </button>
                </div>
                <div class="col-6">
                    <button class="bottom-nav-item" id="searchNavBtn">
                        <i class="fas fa-search"></i>
                        <span>Search</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfzWZEAq7rjpnXfjznTOJ25skrStZ4FHY",
            authDomain: "shop-management-1.firebaseapp.com",
            projectId: "shop-management-1",
            storageBucket: "shop-management-1.firebasestorage.app",
            messagingSenderId: "154721959797",
            appId: "1:154721959797:web:e9c79c83f28d70c68fdd3c",
            measurementId: "G-VEHXPEPWQM"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentShop = null;
        let currentProduct = null;
        let products = [];
        let lastVisible = null;
        let hasMoreProducts = true;
        let isLoading = false;
        const PRODUCTS_PER_PAGE = 8;
        let currentImageIndex = 0;
        let productModal = null;

        // Get shop ID from URL
        function getShopIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load shop data
        async function loadShop() {
            const shopId = getShopIdFromUrl();
            
            if (!shopId) {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('shop-not-found').style.display = 'flex';
                }, 500);
                return;
            }

            try {
                const shopDoc = await db.collection('shops').doc(shopId).get();
                
                if (!shopDoc.exists) {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('shop-not-found').style.display = 'flex';
                    }, 500);
                    return;
                }

                currentShop = { id: shopDoc.id, ...shopDoc.data() };
                
                // Update page title
                document.title = `${currentShop.name} - Shop Creator`;
                
                // Update banner
                const bannerImg = document.getElementById('shop-banner-img');
                const bannerTitle = document.getElementById('shop-banner-title');
                const bannerSubtitle = document.getElementById('shop-banner-subtitle');
                const bannerSkeleton = document.getElementById('bannerSkeleton');
                const bannerContent = document.getElementById('bannerContent');
                
                if (currentShop.bannerUrl) {
                    bannerImg.src = currentShop.bannerUrl;
                } else {
                    // Default banner
                    bannerImg.src = 'https://images.unsplash.com/photo-1445205170230-053b83016050?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80';
                }
                
                bannerImg.onload = () => {
                    bannerSkeleton.style.display = 'none';
                    bannerContent.style.display = 'block';
                };
                
                bannerImg.onerror = () => {
                    bannerImg.src = 'https://via.placeholder.com/1200x400/002f34/ffffff?text=Shop+Banner';
                    bannerSkeleton.style.display = 'none';
                    bannerContent.style.display = 'block';
                };
                
                bannerTitle.textContent = currentShop.name;
                bannerSubtitle.textContent = currentShop.tagline || 'Best Deals on Quality Products';
                
                // Update shop info
                document.getElementById('shop-name').textContent = currentShop.name;
                const logoImg = document.getElementById('shop-logo');
                logoImg.src = currentShop.logoUrl || 'https://via.placeholder.com/150';
                logoImg.onerror = () => {
                    logoImg.src = 'https://via.placeholder.com/150';
                };
                
                document.getElementById('product-count').textContent = currentShop.productCount || 0;
                
                // Format creation date
                if (currentShop.createdAt && currentShop.createdAt.toDate) {
                    const date = currentShop.createdAt.toDate();
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    document.getElementById('shop-created').textContent = date.toLocaleDateString('en-US', options);
                } else {
                    document.getElementById('shop-created').textContent = 'Recently added';
                }

                // Load products
                await loadProducts(shopId);

                // Hide loading screen
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('main-content').style.opacity = '1';
                }, 500);

            } catch (error) {
                console.error('Error loading shop:', error);
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('shop-not-found').style.display = 'flex';
                }, 500);
            }
        }

        // Load products
        async function loadProducts(shopId) {
            try {
                const productsSnapshot = await db.collection('products')
                    .where('shopId', '==', shopId)
                    .where('active', '==', true)
                    .orderBy('createdAt', 'desc')
                    .limit(PRODUCTS_PER_PAGE)
                    .get();

                const productsGrid = document.getElementById('products-grid');
                const productsLoading = document.getElementById('productsLoading');
                const noProducts = document.getElementById('noProducts');
                
                productsLoading.style.display = 'none';
                
                if (productsSnapshot.empty) {
                    noProducts.style.display = 'block';
                    productsGrid.style.display = 'none';
                    return;
                }

                products = [];
                productsSnapshot.forEach(doc => {
                    const data = doc.data();
                    // Ensure price is a number
                    if (typeof data.price === 'string') {
                        data.price = parseFloat(data.price);
                    }
                    if (data.oldPrice && typeof data.oldPrice === 'string') {
                        data.oldPrice = parseFloat(data.oldPrice);
                    }
                    products.push({ id: doc.id, ...data });
                });
                
                lastVisible = productsSnapshot.docs[productsSnapshot.docs.length-1];
                
                if (productsSnapshot.size < PRODUCTS_PER_PAGE) {
                    hasMoreProducts = false;
                }
                
                displayProducts(products);
                
                // Update product count if needed
                if (currentShop) {
                    document.getElementById('product-count').textContent = products.length;
                }

            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-grid').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Error Loading Products</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            }
        }

        // Load more products
        async function loadMoreProducts() {
            if (!hasMoreProducts || isLoading) return;
            
            isLoading = true;
            document.getElementById('productsLoading').style.display = 'flex';
            
            try {
                const productsSnapshot = await db.collection('products')
                    .where('shopId', '==', getShopIdFromUrl())
                    .where('active', '==', true)
                    .orderBy('createdAt', 'desc')
                    .startAfter(lastVisible)
                    .limit(PRODUCTS_PER_PAGE)
                    .get();
                
                const newProducts = [];
                productsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (typeof data.price === 'string') {
                        data.price = parseFloat(data.price);
                    }
                    if (data.oldPrice && typeof data.oldPrice === 'string') {
                        data.oldPrice = parseFloat(data.oldPrice);
                    }
                    newProducts.push({ id: doc.id, ...data });
                });
                
                lastVisible = productsSnapshot.docs[productsSnapshot.docs.length-1];
                
                if (productsSnapshot.size < PRODUCTS_PER_PAGE) {
                    hasMoreProducts = false;
                }
                
                products = [...products, ...newProducts];
                displayProducts(newProducts, true);
                
                isLoading = false;
                document.getElementById('productsLoading').style.display = 'none';
                
            } catch (error) {
                console.error("Error loading more products: ", error);
                isLoading = false;
                document.getElementById('productsLoading').style.display = 'none';
            }
        }

        // Display products
        function displayProducts(productsToDisplay, append = false) {
            const productsGrid = document.getElementById('products-grid');
            const noProducts = document.getElementById('noProducts');
            
            if (productsToDisplay.length === 0 && !append) {
                noProducts.style.display = 'block';
                productsGrid.style.display = 'none';
                return;
            }
            
            noProducts.style.display = 'none';
            productsGrid.style.display = 'grid';
            
            if (!append) {
                productsGrid.innerHTML = '';
            }
            
            productsToDisplay.forEach(product => {
                const price = product.price || 0;
                const oldPrice = product.oldPrice || 0;
                const discount = oldPrice > 0 ? Math.round(((oldPrice - price) / oldPrice) * 100) : 0;
                
                // Get image URL
                let imageUrl = 'https://via.placeholder.com/300';
                if (product.imageUrls && product.imageUrls.length > 0) {
                    imageUrl = product.imageUrls[0];
                } else if (product.imageUrl) {
                    imageUrl = product.imageUrl;
                }
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-img-container">
                        <img src="${imageUrl}" class="product-img" alt="${product.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/300'">
                        ${discount > 0 ? `<div class="product-badge">-${discount}%</div>` : ''}
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${product.name || 'Unnamed Product'}</h3>
                        <div class="product-price-container">
                            <span class="product-price">$${price.toFixed(2)}</span>
                            ${oldPrice > 0 ? `<span class="product-old-price">$${oldPrice.toFixed(2)}</span>` : ''}
                        </div>
                        <button class="btn-buy" data-product-id="${product.id}">
                            <i class="fas fa-external-link-alt"></i> View
                        </button>
                    </div>
                `;
                
                productCard.addEventListener('click', () => {
                    openProductModal(product);
                });
                
                const buyBtn = productCard.querySelector('.btn-buy');
                buyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openProductModal(product);
                });
                
                productsGrid.appendChild(productCard);
            });
        }

        // Open product modal
        function openProductModal(product) {
            currentProduct = product;
            
            const discount = product.oldPrice ? Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100) : 0;
            
            document.getElementById('modal-product-title').textContent = product.name;
            document.getElementById('modal-product-name').textContent = product.name;
            document.getElementById('modal-product-price').textContent = `$${product.price.toFixed(2)}`;
            document.getElementById('modal-product-description').innerText = product.description || 'No description available';
            
            // Get all image URLs
            let imageUrls = [];
            if (product.imageUrls && product.imageUrls.length > 0) {
                imageUrls = product.imageUrls;
            } else if (product.imageUrl) {
                imageUrls = [product.imageUrl];
            } else {
                imageUrls = ['https://via.placeholder.com/500'];
            }
            
            // Build image gallery
            buildImageGallery(imageUrls);
            
            if (product.oldPrice) {
                document.getElementById('modal-product-old-price').textContent = `$${product.oldPrice.toFixed(2)}`;
                document.getElementById('modal-product-old-price').style.display = 'inline';
                document.getElementById('modal-product-discount').textContent = `-${discount}%`;
                document.getElementById('modal-product-discount').style.display = 'inline-block';
            } else {
                document.getElementById('modal-product-old-price').style.display = 'none';
                document.getElementById('modal-product-discount').style.display = 'none';
            }
            
            if (!productModal) {
                productModal = new bootstrap.Modal(document.getElementById('product-modal'));
            }
            productModal.show();
        }

        // Build image gallery
        function buildImageGallery(imageUrls) {
            const galleryScroll = document.getElementById('productGalleryScroll');
            const galleryDots = document.getElementById('imageGalleryDots');
            
            galleryScroll.innerHTML = '';
            galleryDots.innerHTML = '';
            
            // Add swipe indicator for multiple images
            if (imageUrls.length > 1) {
                const swipeIndicator = document.createElement('div');
                swipeIndicator.className = 'swipe-indicator';
                swipeIndicator.innerHTML = '<i class="fas fa-arrow-left"></i><i class="fas fa-arrow-right"></i> Swipe';
                document.getElementById('productGalleryContainer').appendChild(swipeIndicator);
            }
            
            imageUrls.forEach((url, index) => {
                // Create slide
                const slide = document.createElement('div');
                slide.className = 'product-gallery-slide';
                slide.innerHTML = `<img src="${url}" class="product-gallery-image" alt="Product image ${index + 1}" onerror="this.src='https://via.placeholder.com/500'">`;
                galleryScroll.appendChild(slide);
                
                // Create dot
                const dot = document.createElement('button');
                dot.className = 'image-gallery-dot' + (index === 0 ? ' active' : '');
                dot.dataset.index = index;
                dot.addEventListener('click', () => scrollToImage(index));
                galleryDots.appendChild(dot);
            });
            
            currentImageIndex = 0;
            
            // Add scroll event listener
            galleryScroll.addEventListener('scroll', updateActiveDot);
        }

        // Scroll to image
        function scrollToImage(index) {
            const scrollContainer = document.getElementById('productGalleryScroll');
            const slideWidth = scrollContainer.offsetWidth;
            scrollContainer.scrollTo({
                left: index * slideWidth,
                behavior: 'smooth'
            });
            currentImageIndex = index;
            updateDots();
        }

        // Navigate gallery
        function navigateGallery(direction) {
            const totalImages = document.getElementById('productGalleryScroll').childElementCount;
            
            if (direction === 'next') {
                currentImageIndex = (currentImageIndex + 1) % totalImages;
            } else {
                currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages;
            }
            
            scrollToImage(currentImageIndex);
        }

        // Update active dot
        function updateActiveDot() {
            const scrollContainer = document.getElementById('productGalleryScroll');
            const slideWidth = scrollContainer.offsetWidth;
            const scrollPosition = scrollContainer.scrollLeft;
            const newIndex = Math.round(scrollPosition / slideWidth);
            
            if (newIndex !== currentImageIndex && newIndex >= 0 && newIndex < scrollContainer.childElementCount) {
                currentImageIndex = newIndex;
                updateDots();
            }
        }

        // Update dots
        function updateDots() {
            const dots = document.querySelectorAll('.image-gallery-dot');
            dots.forEach((dot, index) => {
                if (index === currentImageIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Close modal
        function closeModal() {
            if (productModal) {
                productModal.hide();
            }
        }

        // Buy product
        function buyProduct() {
            if (currentProduct && currentProduct.affiliateLink) {
                window.open(currentProduct.affiliateLink, '_blank');
                if (productModal) {
                    productModal.hide();
                }
            } else {
                alert('This product is not available for purchase at the moment.');
            }
        }

        // Handle scroll for infinite loading
        function handleScroll() {
            if (!hasMoreProducts || isLoading) return;
            
            const productCards = document.querySelectorAll('.product-card');
            if (productCards.length >= 2) {
                const secondLastProduct = productCards[productCards.length - 2];
                const rect = secondLastProduct.getBoundingClientRect();
                
                if (rect.top <= window.innerHeight + 100) {
                    loadMoreProducts();
                }
            }
        }

        // Handle search
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
            
            if (!searchTerm) {
                loadProducts(getShopIdFromUrl());
                return;
            }
            
            const productsGrid = document.getElementById('products-grid');
            const productsLoading = document.getElementById('productsLoading');
            const noProducts = document.getElementById('noProducts');
            
            productsGrid.innerHTML = '';
            productsLoading.style.display = 'flex';
            noProducts.style.display = 'none';
            
            db.collection('products')
                .where('shopId', '==', getShopIdFromUrl())
                .where('active', '==', true)
                .get()
                .then((querySnapshot) => {
                    const allProducts = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (typeof data.price === 'string') {
                            data.price = parseFloat(data.price);
                        }
                        if (data.oldPrice && typeof data.oldPrice === 'string') {
                            data.oldPrice = parseFloat(data.oldPrice);
                        }
                        allProducts.push({ id: doc.id, ...data });
                    });
                    
                    const filteredProducts = allProducts.filter(product => 
                        product.name.toLowerCase().includes(searchTerm) || 
                        (product.description && product.description.toLowerCase().includes(searchTerm))
                    );
                    
                    displaySearchResults(filteredProducts, searchTerm);
                    productsLoading.style.display = 'none';
                })
                .catch((error) => {
                    console.error("Error searching products: ", error);
                    productsGrid.innerHTML = '<div class="alert alert-danger">Error searching products</div>';
                    productsLoading.style.display = 'none';
                });
        }

        // Display search results
        function displaySearchResults(products, searchTerm) {
            const productsGrid = document.getElementById('products-grid');
            const noProducts = document.getElementById('noProducts');
            
            if (products.length === 0) {
                noProducts.innerHTML = `
                    <i class="fas fa-search fa-3x mb-3" style="opacity: 0.3;"></i>
                    <h3>No Products Found</h3>
                    <p>No results for "${searchTerm}"</p>
                `;
                noProducts.style.display = 'block';
                productsGrid.style.display = 'none';
                hasMoreProducts = true;
                lastVisible = null;
                return;
            }
            
            noProducts.style.display = 'none';
            productsGrid.style.display = 'grid';
            productsGrid.innerHTML = '';
            
            hasMoreProducts = false;
            
            displayProducts(products);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            loadProducts(getShopIdFromUrl());
            
            // Focus on home tab
            document.getElementById('homeNavBtn').click();
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadShop();
            
            // Setup event listeners
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('searchBtn').addEventListener('click', handleSearch);
            document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
            document.getElementById('modal-buy-btn').addEventListener('click', buyProduct);
            
            // Gallery navigation
            document.getElementById('galleryPrev').addEventListener('click', () => navigateGallery('prev'));
            document.getElementById('galleryNext').addEventListener('click', () => navigateGallery('next'));
            
            // Bottom navigation
            document.getElementById('homeNavBtn').addEventListener('click', function() {
                document.querySelectorAll('.bottom-nav-item').forEach(item => item.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('searchInput').value = '';
                document.getElementById('clearSearchBtn').style.display = 'none';
                loadProducts(getShopIdFromUrl());
            });
            
            document.getElementById('searchNavBtn').addEventListener('click', function() {
                document.querySelectorAll('.bottom-nav-item').forEach(item => item.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('searchInput').focus();
            });
            
            // Scroll event for infinite loading
            window.addEventListener('scroll', debounce(handleScroll, 100));
            
            // Close modal with escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && productModal) {
                    productModal.hide();
                }
            });
        });

        // Handle URL changes
        window.addEventListener('popstate', () => {
            loadShop();
        });
    </script>
</body>
</html>